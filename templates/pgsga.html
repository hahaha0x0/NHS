<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f5f7fa;
      padding: 2rem 0;
    }

   .container {
      max-width: 1000px;
      width: 90%;
      margin: 0 auto;
    }

   .card {
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

   .card-header {
      background-color: #49b8ab;
      padding: 1.25rem;
      border-bottom: 1px solid #ddd;
    }

   .question-section {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #eee;
    }

   .question-section h4 {
      color: #333;
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #ddd;
    }

   .question-text {
      margin-bottom: 0.8rem;
      font-weight: 500;
    }

    /* 按钮组样式：垂直排列、等宽、左对齐 */
   .btn-group-custom {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

   .btn-option {
      width: 100%;
    }

   .btn-option input[type="radio"],
   .btn-option input[type="checkbox"] {
      display: none;
    }

   .btn-option label {
      width: 100%;
      text-align: left;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid #ccc;
      margin: 0;
      font-size: 14px;
      border-radius: 4px;
      background-color: #fff;
      color: #333;
      display: block;
    }

   .btn-option label:hover {
      background-color: #f8f9fa;
    }

   .btn-option input[type="radio"]:checked + label,
   .btn-option input[type="checkbox"]:checked + label {
      background-color: #3bd1cb;
      color: #000;
      border-color: #3bd1cb;
    }

    /* 计分区域样式 */
   .info-section {
      margin-top: 1.5rem;
    }

   .gray-box {
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 4px;
    }

   .gray-box h5 {
      margin-top: 0;
      margin-bottom: 0.8rem;
      color: #333;
      font-weight: 600;
      border-bottom: 1px solid #ddd;
      padding-bottom: 0.5rem;
    }

   .gray-box p {
      margin: 0.5rem 0;
      font-size: 14px;
      line-height: 1.5;
    }

   .gray-box table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }

   .gray-box table th,
   .gray-box table td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: left;
    }

   .gray-box table th {
      background-color: #e9ecef;
    }

   .score-value {
      font-weight: bold;
      color: #2eaee2;
    }

   .action-buttons {
      margin-top: 1.5rem;
    }

    /* 体重输入框样式 */
   .weight-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin: 1rem 0;
    }

   .weight-inputs input {
      width: 100px;
      margin: 0 0.5rem;
      padding: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <h2>Patient-Generated Subjective Global Assessment (PG-SGA)</h2>
        <p class="text-muted">Please answer the following questions based on your actual situation（3/3）</p>
      </div>
      <div class="card-body">
        <form id="pgsgaForm">
          <!-- 1. 体重相关问题 -->
          <div class="question-section">
            <h4>1. Weight</h4>
            <p class="question-text">In summary of my current and recent weight:</p>
            <div class="weight-inputs">
              <div>
                I currently weigh about <input type="number" id="current_weight" name="current_weight" required> kg
              </div>
              <div>
                I am about <input type="number" id="height" name="height" required> cm tall
              </div>
            </div>
            <div class="weight-inputs">
              <div>
                One month ago I weighed about <input type="number" id="weight_1month" name="weight_1month" required> kg
              </div>
              <div>
                Six months ago I weighed about <input type="number" id="weight_6month" name="weight_6month" required> kg
              </div>
            </div>
            <p class="question-text">During the past two weeks my weight has:</p>
            <div class="btn-group-custom">
              <div class="btn-option">
                <input type="radio" id="weight_change-1" name="weight_change" value="1" required />
                <label for="weight_change-1">decreased <span>+1</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="weight_change-0" name="weight_change" value="0" />
                <label for="weight_change-0">not changed <span>0</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="weight_change-2" name="weight_change" value="0" />
                <label for="weight_change-2">increased <span>0</span></label>
              </div>
            </div>
          </div>

          <!-- 2. 食物摄入问题 -->
          <div class="question-section">
            <h4>2. Food intake</h4>
            <p class="question-text">As compared to my normal intake, I would rate my food intake during the past month as:</p>
            <div class="btn-group-custom">
              <div class="btn-option">
                <input type="radio" id="food_intake-0" name="food_intake" value="0" required />
                <label for="food_intake-0">unchanged <span>0</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="food_intake-1" name="food_intake" value="0" />
                <label for="food_intake-1">More than usual <span>0</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="food_intake-2" name="food_intake" value="1" />
                <label for="food_intake-2">less than usual <span>+1</span></label>
              </div>
            </div>

            <p class="question-text">I am now taking:</p>
            <div class="btn-group-custom">
              <div class="btn-option">
                <input type="radio" id="food_type-0" name="food_type" value="1" required />
                <label for="food_type-0">normal food but less than normal amount <span>+1</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="food_type-1" name="food_type" value="2" />
                <label for="food_type-1">little solid food <span>+2</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="food_type-2" name="food_type" value="3" />
                <label for="food_type-2">only liquids <span>+3</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="food_type-3" name="food_type" value="3" />
                <label for="food_type-3">only nutrition supplements <span>+3</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="food_type-4" name="food_type" value="4" />
                <label for="food_type-4">very little of anything <span>+4</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="food_type-5" name="food_type" value="0" />
                <label for="food_type-5">only tube feedings or only nutrition by vein <span>+0</span></label>
              </div>
            </div>
          </div>

          <!-- 3. 症状问题（多选） -->
          <div class="question-section">
            <h4>3. Symptoms</h4>
            <p class="question-text">I have had the following problems that have kept me from eating enough during the past two weeks (check all that apply)</p>
            <div class="btn-group-custom">
              <div class="btn-option">
                <input type="checkbox" id="symptom-0" name="symptom" value="0" />
                <label for="symptom-0">no problem eating <span>+0</span></label>
              </div>
              <div class="btn-option">
                <input type="checkbox" id="symptom-1" name="symptom" value="3" />
                <label for="symptom-1">no appetite,just did not feel like eating <span>+3</span></label>
              </div>
              <div class="btn-option">
                <input type="checkbox" id="symptom-2" name="symptom" value="1" />
                <label for="symptom-2">nausea <span>+1</span></label>
              </div>
              <div class="btn-option">
                <input type="checkbox" id="symptom-3" name="symptom" value="3" />
                <label for="symptom-3">vomiting <span>+3</span></label>
              </div>
              <div class="btn-option">
                <input type="checkbox" id="symptom-4" name="symptom" value="1" />
                <label for="symptom-4">constipation <span>+1</span></label>
              </div>
              <div class="btn-option">
                <input type="checkbox" id="symptom-5" name="symptom" value="3" />
                <label for="symptom-5">diarrhea <span>+3</span></label>
              </div>
              <div class="btn-option">
                <input type="checkbox" id="symptom-6" name="symptom" value="2" />
                <label for="symptom-6">mouth sores <span>+2</span></label>
              </div>
              <div class="btn-option">
                <input type="checkbox" id="symptom-7" name="symptom" value="1" />
                <label for="symptom-7">dry mouth <span>+1</span></label>
              </div>
              <div class="btn-option">
                <input type="checkbox" id="symptom-8" name="symptom" value="1" />
                <label for="symptom-8">smells bother me <span>+1</span></label>
              </div>
              <div class="btn-option">
                <input type="checkbox" id="symptom-9" name="symptom" value="1" />
                <label for="symptom-9">feel full quickly <span>+1</span></label>
              </div>
              <div class="btn-option">
                <input type="checkbox" id="symptom-10" name="symptom" value="2" />
                <label for="symptom-10">problems swallowing <span>+2</span></label>
              </div>
              <div class="btn-option">
                <input type="checkbox" id="symptom-11" name="symptom" value="1" />
                <label for="symptom-11">fatigue <span>+1</span></label>
              </div>
              <div class="btn-option">
                <input type="checkbox" id="symptom-12" name="symptom" value="3" />
                <label for="symptom-12">pain;where? <span>+3</span></label>
                <input type="text" id="pain_detail" class="form-control mt-1" placeholder="Please specify where the pain is" />
              </div>
              <div class="btn-option">
                <input type="checkbox" id="symptom-13" name="symptom" value="1" />
                <label for="symptom-13">other ** <span>+1</span></label>
                <input type="text" id="other_detail" class="form-control mt-1" placeholder="Please specify other symptoms" />
              </div>
            </div>
            <p class="question-text">**Examples: depression, money, or dental problems</p>
          </div>

          <!-- 4. 活动与功能问题 -->
          <div class="question-section">
            <h4>4. Activities and Function</h4>
            <p class="question-text">Over the past month, I would generally rate my activity as:</p>
            <div class="btn-group-custom">
              <div class="btn-option">
                <input type="radio" id="activity-0" name="activity" value="0" required />
                <label for="activity-0">normal with no limitations <span>+0</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="activity-1" name="activity" value="1" />
                <label for="activity-1">not my normal self, but able to be up and about with fairly normal activities <span>+1</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="activity-2" name="activity" value="2" />
                <label for="activity-2">no feeling up to most things, but in bed or chair less than half the day <span>+2</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="activity-3" name="activity" value="3" />
                <label for="activity-3">able to do little activity and spend most of the day in bed or chair <span>+3</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="activity-4" name="activity" value="4" />
                <label for="activity-4">pretty much bed ridden, rarely out of bed <span>+4</span></label>
              </div>
            </div>
          </div>

          <!-- 计分区域 -->
          <div class="info-section">
            <div class="gray-box">
              <h5>Scoring Results</h5>
              <p style="font-size: 20px;">Your score is : <span class="score-value" id="pgsgaScore">0</span> points</p>
              <p>Scores ≤1 suggest low risk which may not require treatment.</p>
            </div>

            <div class="gray-box">
              <h5>FORMULA</h5>
              <p>Box 1 (weight history): additive</p>
              <p>Box 2 (food intake): non-additive, use highest score</p>
              <p>Box 3 (symptoms): additive</p>
              <p>Box 4 (activities and function): non-additive, use highest score</p>
              <p>Final score is additive score of boxes 1-4</p>
            </div>

            <div class="gray-box">
              <h5>ADVICE</h5>
              <p>Final diagnosis should be made with clinical interview and mental status examination including assessment of patient's level of distress and functional impairment.</p>
            </div>

            <div class="gray-box">
              <h5>MANAGEMENT</h5>
              <table>
                <thead>
                  <tr>
                    <th>Score</th>
                    <th>Level</th>
                    <th>Comments</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>0-1</td>
                    <td>Universal</td>
                    <td>Monitor; may not require treatment</td>
                  </tr>
                  <tr>
                    <td>2-3</td>
                    <td>Targeted</td>
                    <td>Use clinical judgment to determine necessity of treatment</td>
                  </tr>
                  <tr>
                    <td>≥4</td>
                    <td>Specialist</td>
                    <td>Warrants active treatment with nutrition intervention or other therapies</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- 按钮区域 -->
          <div class="d-flex justify-content-between action-buttons">
            <a href="/user/questionnaires/phq4" class="btn btn-secondary">Back</a>
            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>提交问卷</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // 登录状态检查
  const token = localStorage.getItem('access_token');
  if (!token) {
    window.location.href = 'login.html';
  }

  // 实时计算分数
  $(document).ready(function () {
    // 监听所有输入变化（单选框、多选框、体重输入、文本框）
    $('input[type="radio"], input[type="checkbox"], input[type="number"], input[type="text"]').change(function () {
      calculateScores();
      checkAllAnswered();
    });

    // 计算PG-SGA总分（按文档公式）
    function calculateScores() {
      let total = 0;

      // 1. 体重变化分数（weight_change的值直接累加）
      const weightChange = parseFloat($('input[name="weight_change"]:checked').val() || 0);
      total += weightChange;

      // 2. 食物摄入分数（取最高值）
      const foodIntake = parseFloat($('input[name="food_intake"]:checked').val() || 0);
      const foodType = parseFloat($('input[name="food_type"]:checked').val() || 0);
      total += Math.max(foodIntake, foodType);

      // 3. 症状分数（多选值累加）
      let symptomTotal = 0;
      $('input[name="symptom"]:checked').each(function () {
        symptomTotal += parseFloat($(this).val() || 0);
      });
      total += symptomTotal;

      // 4. 活动功能分数（单选值直接累加）
      const activity = parseFloat($('input[name="activity"]:checked').val() || 0);
      total += activity;

      $('#pgsgaScore').text(total);
    }

    // 检查是否所有问题都已回答
    function checkAllAnswered() {
      // 检查体重输入框
      const weightInputs = ['current_weight', 'height', 'weight_1month', 'weight_6month'];
      let weightComplete = true;
      weightInputs.forEach(id => {
        if (!$('#' + id).val()) weightComplete = false;
      });

      // 检查所有单选框组
      const radioGroups = ['weight_change', 'food_intake', 'food_type', 'activity'];
      let radioComplete = true;
      radioGroups.forEach(group => {
        if (!$('input[name="' + group + '"]:checked').length) radioComplete = false;
      });

      // 检查症状多选至少选一个
      const symptomComplete = $('input[name="symptom"]:checked').length > 0;

      // 启用/禁用提交按钮
      $('#submitBtn').prop('disabled',!(weightComplete && radioComplete && symptomComplete));
    }

    // 表单提交处理（解决422报错 + 存储到数据库）
    $('#pgsgaForm').submit(function (e) {
      e.preventDefault();

      // 收集表单数据（包含文本框内容和必要字段）
      const formData = {
        type: 'pgsga', // 问卷类型
        score: parseFloat($('#pgsgaScore').text()), // 总分（数字类型）
        level: getPgsgaLevel(), // 等级（字符串类型：Universal/Targeted/Specialist）
        answers: {
          // 体重数据
          current_weight: $('#current_weight').val(),
          height: $('#height').val(),
          weight_1month: $('#weight_1month').val(),
          weight_6month: $('#weight_6month').val(),
          // 单选框数据
          weight_change: $('input[name="weight_change"]:checked').val(),
          food_intake: $('input[name="food_intake"]:checked').val(),
          food_type: $('input[name="food_type"]:checked').val(),
          activity: $('input[name="activity"]:checked').val(),
          // 多选症状数据
          symptoms: $('input[name="symptom"]:checked').map(function() {
            return $(this).val();
          }).get(),
          // 文本框数据（假设文本框ID为pain_detail和other_detail）
          pain_detail: $('#pain_detail').val() || '', // 疼痛位置详情
          other_detail: $('#other_detail').val() || '' // 其他症状详情
        }
      };

      // 发送数据到后端接口（存储到数据库）
      $.ajax({
        url: '/user/questionnaires', // 后端接收问卷的接口
        type: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('access_token')}`, // 身份验证
          'Content-Type': 'application/json' // 声明JSON格式
        },
        data: JSON.stringify(formData), // 转换为JSON字符串
        success: function (response) {
          // 保存到本地存储（可选，用于前端状态记录）
          localStorage.setItem('pgsga_answers', JSON.stringify(formData.answers));
          localStorage.setItem('questionnaire_progress', JSON.stringify({
            dasi: 'completed',
            phq4: 'completed',
            pgsga: 'completed'
          }));
          // 跳转至用户仪表盘
          window.location.href = '/user';
        },
        error: function (xhr) {
          // 错误提示（显示具体原因）
          alert(`提交失败：${xhr.responseJSON?.msg || '服务器错误'}`);
          console.error('错误详情：', xhr.responseJSON);
        }
      });
    });

    // 计算PG-SGA等级（根据分数判定）
    function getPgsgaLevel() {
      const score = parseFloat($('#pgsgaScore').text());
      if (score <= 1) return 'Universal';
      if (score <= 3) return 'Targeted';
      return 'Specialist';
    }
  });
</script>
</body>

</html>