<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f5f7fa;
      padding: 2rem 0;
    }

   .container {
      max-width: 1000px;
      width: 90%;
      margin: 0 auto;
    }

   .card {
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

   .card-header {
      background-color: #49b8ab;
      padding: 1.25rem;
      border-bottom: 1px solid #ddd;
    }

    /* 问题项容器：改为水平布局，问题文本左对齐，按钮组右对齐 */
   .question-item {
      display: flex;
      align-items: flex-start; /* 顶部对齐 */
      justify-content: space-between; /* 两端对齐 */
      border-bottom: 1px solid #eee;
      padding: 1.2rem 0;
    }

   .question-text {
      flex: 1; /* 让问题文本占满左侧空间 */
      margin-right: 2rem; /* 与按钮组保持间距 */
    }

   .question-text p {
      font-weight: 500;
      margin-bottom: 0;
    }

    /* 按钮组容器：垂直堆叠，固定宽度确保长度相等 */
   .btn-group-custom {
      display: flex;
      flex-direction: column; /* 垂直排列按钮 */
      width: 220px; /* 固定宽度，与示例图匹配 */
      gap: 0.3rem; /* 按钮之间的间距 */
    }

   .btn-option {
      width: 100%; /* 按钮占满容器宽度 */
    }

   .btn-option input[type="radio"] {
      display: none;
    }

   .btn-option label {
      width: 100%;
      text-align: left; /* 文字左对齐，与示例图一致 */
      padding: 0.5rem 1rem; /* 调整内边距，让按钮更舒展 */
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid #ccc;
      margin: 0;
      font-size: 14px;
      border-radius: 4px; /* 每个按钮独立圆角 */
      display: flex;
      justify-content: space-between; /* 让选项文字和分数分别居左、居右 */
      align-items: center;
    }

    /* 按钮样式与示例图匹配 */
   .btn-option label {
      background-color: #fff; /* 白色背景 */
      color: #333;
    }

   .btn-option label:hover {
      background-color: #f8f9fa; /* hover 浅灰色 */
    }

   .btn-option input[type="radio"]:checked + label {
      background-color: #3bd1cb; /* 选中的亮蓝色，与示例图匹配 */
      color: #000;
      border-color: #3bd1cb;
    }

    /* 计分区域样式 */
   .info-section {
      margin-top: 1.5rem;
    }

   .gray-box {
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 4px;
    }

   .gray-box h5 {
      margin-top: 0;
      margin-bottom: 0.8rem;
      color: #333;
      font-weight: 600;
      border-bottom: 1px solid #ddd;
      padding-bottom: 0.5rem;
    }

   .gray-box p {
      margin: 0.5rem 0;
      font-size: 14px;
      line-height: 1.5;
    }

   .gray-box table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }

   .gray-box table th,
   .gray-box table td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: left;
    }

   .gray-box table th {
      background-color: #e9ecef;
    }

   .score-value {
      font-weight: bold;
      color: #2eaee2;
    }

   .action-buttons {
      margin-top: 1.5rem;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <h2>Patient Health Questionnaire-4 (PHQ-4)</h2>
        <p class="text-muted">Please answer the following questions based on your actual situation（2/3）</p>
        <p class="text-muted" style="font-size: 16px; font-weight: bold;">
          How often have you been bothered by the following over the past 2 weeks?
        </p>
      </div>
      <div class="card-body">
        <form id="phq4Form">
          <!-- 问题1 -->
          <div class="question-item">
            <div class="question-text">
              <p>1. Feeling nervous, anxious or on edge</p>
            </div>
            <div class="btn-group-custom">
              <div class="btn-option">
                <input type="radio" id="q1-0" name="q1" value="0" required />
                <label for="q1-0">Not at all <span>0</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="q1-1" name="q1" value="1" />
                <label for="q1-1">Several days <span>+1</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="q1-2" name="q1" value="2" />
                <label for="q1-2">More than half the days <span>+2</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="q1-3" name="q1" value="3" />
                <label for="q1-3">Nearly every day <span>+3</span></label>
              </div>
            </div>
          </div>

          <!-- 问题2 -->
          <div class="question-item">
            <div class="question-text">
              <p>2. Not being able to stop or control worrying</p>
            </div>
            <div class="btn-group-custom">
              <div class="btn-option">
                <input type="radio" id="q2-0" name="q2" value="0" required />
                <label for="q2-0">Not at all <span>0</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="q2-1" name="q2" value="1" />
                <label for="q2-1">Several days <span>+1</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="q2-2" name="q2" value="2" />
                <label for="q2-2">More than half the days <span>+2</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="q2-3" name="q2" value="3" />
                <label for="q2-3">Nearly every day <span>+3</span></label>
              </div>
            </div>
          </div>

          <!-- 问题3 -->
          <div class="question-item">
            <div class="question-text">
              <p>3. Feeling down, depressed or hopeless</p>
            </div>
            <div class="btn-group-custom">
              <div class="btn-option">
                <input type="radio" id="q3-0" name="q3" value="0" required />
                <label for="q3-0">Not at all <span>0</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="q3-1" name="q3" value="1" />
                <label for="q3-1">Several days <span>+1</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="q3-2" name="q3" value="2" />
                <label for="q3-2">More than half the days <span>+2</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="q3-3" name="q3" value="3" />
                <label for="q3-3">Nearly every day <span>+3</span></label>
              </div>
            </div>
          </div>

          <!-- 问题4 -->
          <div class="question-item">
            <div class="question-text">
              <p>4. Little interest or pleasure in doing things</p>
            </div>
            <div class="btn-group-custom">
              <div class="btn-option">
                <input type="radio" id="q4-0" name="q4" value="0" required />
                <label for="q4-0">Not at all <span>0</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="q4-1" name="q4" value="1" />
                <label for="q4-1">Several days <span>+1</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="q4-2" name="q4" value="2" />
                <label for="q4-2">More than half the days <span>+2</span></label>
              </div>
              <div class="btn-option">
                <input type="radio" id="q4-3" name="q4" value="3" />
                <label for="q4-3">Nearly every day <span>+3</span></label>
              </div>
            </div>
          </div>

          <!-- 计分区域 -->
          <div class="info-section">
            <div class="gray-box">
              <h5>Scoring Results</h5>
              <p style="font-size: 20px;">Your score is : <span class="score-value" id="phq4Score">0</span> points</p>
              <p>Scores ≤5 suggest minimal depression which may not require treatment.</p>
            </div>

            <div class="gray-box">
              <h5>FORMULA</h5>
              <p>Addition of the selected points.</p>
            </div>

            <div class="gray-box">
              <h5>ADVICE</h5>
              <p>Final diagnosis should be made with clinical interview and mental status examination including assessment of patient's level of distress and functional impairment.</p>
            </div>

            <div class="gray-box">
              <h5>MANAGEMENT</h5>
              <table>
                <thead>
                  <tr>
                    <th>Score</th>
                    <th>Level</th>
                    <th>Comments</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>0-5</td>
                    <td>Universal</td>
                    <td>Monitor; may not require treatment</td>
                  </tr>
                  <tr>
                    <td>6-8</td>
                    <td>Targeted</td>
                    <td>Use clinical judgment (symptom duration, functional impairment) to determine necessity of treatment</td>
                  </tr>
                  <tr>
                    <td>9-12</td>
                    <td>Specialist</td>
                    <td>Warrants active treatment with psychotherapy, medications, or combination</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- 按钮区域 -->
          <div class="d-flex justify-content-between action-buttons">
            <a href="/user/questionnaires/dasi" class="btn btn-secondary">Back</a>
            <button type="submit" class="btn btn-primary" id="nextBtn" disabled>Next Step</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  // 登录状态检查
    const token = localStorage.getItem('access_token');
    if (!token) {
      window.location.href = 'login.html';
    }else {
     // 关键修改：登录成功后清除上一次的问卷数据，避免显示旧结果
     localStorage.removeItem('dasi_answers');
     localStorage.removeItem('phq4_answers');
     localStorage.removeItem('questionnaire_progress');
    }

    // 页面加载时恢复已保存数据
    $(document).ready(function () {
      loadSavedData();
      $('input[type="radio"]').change(function () {
        saveData();
        calculateScores();
        checkAllAnswered();
      });
    });

    // 从本地存储加载数据
    function loadSavedData() {
      const savedData = localStorage.getItem('phq4_answers');
      if (savedData) {
        const data = JSON.parse(savedData);
      // 恢复单选框状态
        for (let i = 1; i <= 4; i++) {
          if (data[`q${i}`]) {
            $(`input[name="q${i}"][value="${data[`q${i}`]}"]`).prop('checked', true);
          }
        }
        // 恢复分数显示
        $('#phq4Score').text(data.phq4_total || '0');
        checkAllAnswered();
      }
    }

    // 实时保存数据到本地存储
    function saveData() {
      const formData = {};
      for (let i = 1; i <= 4; i++) {
        formData[`q${i}`] = $(`input[name="q${i}"]:checked`).val() || '';
      }
      formData.phq4_total = $('#phq4Score').text();
      localStorage.setItem('phq4_answers', JSON.stringify(formData));
    }

    // 计算PHQ-4总分（所有选项分数相加）
    function calculateScores() {
      let total = 0;
      for (let i = 1; i <= 4; i++) {
        const selectedValue = parseFloat($(`input[name="q${i}"]:checked`).val() || 0);
        total += selectedValue;
      }
      $('#phq4Score').text(total);
    }

    // 检查是否所有问题都已回答
    function checkAllAnswered() {
      let allAnswered = true;
      for (let i = 1; i <= 4; i++) {
        if (!$(`input[name="q${i}"]:checked`).length) {
          allAnswered = false;
          break;
        }
      }
      $('#nextBtn').prop('disabled', !allAnswered);
    }

    // 表单提交处理（保存到数据库）
    $('#phq4Form').submit(function (e) {
      e.preventDefault();
      const formData = {
        type: 'phq4',
        answers: JSON.parse(localStorage.getItem('phq4_answers')),
        score: parseFloat($('#phq4Score').text()),  // PHQ4分数
        level: getPhq4Level()  // PHQ4等级
      };

      // 提交到后端接口
      $.ajax({
        url: '/user/questionnaires',
        type: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
          'Content-Type': 'application/json'
        },
        data: JSON.stringify(formData),
        success: function () {
          localStorage.setItem('questionnaire_progress', JSON.stringify({
            dasi: 'completed',
            phq4: 'completed',
            pgsga: 'pending'
          }));
          window.location.href = '/user/questionnaires/pgsga';
        },
        error: function (xhr) {
        alert(`PHQ4提交失败：${xhr.responseJSON?.msg || xhr.statusText}`);
        }
      });
    });

    // 按文档标准判定PHQ-4等级
    function getPhq4Level() {
      const score = parseFloat($('#phq4Score').text());
      if (score <= 5) return 'Universal';
      if (score <= 8) return 'Targeted';
      return 'Specialist';

    }
  </script>
</body>

</html>